name: Release Desktop

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

concurrency:
  group: release-desktop-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-macos:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Set package versions from tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Using release version: ${VERSION}"

          ROOT_OK=true
          WORKSPACE_OK=true

          # Try npm version first; if either update fails in CI, fallback to direct JSON update.
          if ! npm version "${VERSION}" --no-git-tag-version --allow-same-version; then
            ROOT_OK=false
          fi
          if ! npm version "${VERSION}" --no-git-tag-version --allow-same-version -w @seedworld/desktop; then
            WORKSPACE_OK=false
          fi

          if [ "${ROOT_OK}" != "true" ] || [ "${WORKSPACE_OK}" != "true" ]; then
            echo "npm version failed for root or workspace, using fallback updater"
            node -e 'const fs=require("fs");const p=["package.json","apps/desktop/package.json"];const v=process.argv[1];for(const f of p){const j=JSON.parse(fs.readFileSync(f,"utf8"));j.version=v;fs.writeFileSync(f,JSON.stringify(j,null,2)+"\n");}' "${VERSION}"
          fi

          node -e 'const root=require("./package.json");const desktop=require("./apps/desktop/package.json");console.log("root version:",root.version);console.log("desktop version:",desktop.version);'

      - name: Build desktop (electron-forge make)
        run: npm run make --workspace @seedworld/desktop

      - name: Collect macOS artifacts
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets/macos
          find apps/desktop/out/make -type f -name "*.dmg" -exec cp {} release-assets/macos/ \;
          ls -la release-assets/macos
          compgen -G "release-assets/macos/*.dmg" > /dev/null || { echo "No DMG produced"; exit 1; }

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-macos
          path: release-assets/macos/*
          if-no-files-found: error

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Set package versions from tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Using release version: ${VERSION}"

          ROOT_OK=true
          WORKSPACE_OK=true

          # Try npm version first; if either update fails in CI, fallback to direct JSON update.
          if ! npm version "${VERSION}" --no-git-tag-version --allow-same-version; then
            ROOT_OK=false
          fi
          if ! npm version "${VERSION}" --no-git-tag-version --allow-same-version -w @seedworld/desktop; then
            WORKSPACE_OK=false
          fi

          if [ "${ROOT_OK}" != "true" ] || [ "${WORKSPACE_OK}" != "true" ]; then
            echo "npm version failed for root or workspace, using fallback updater"
            node -e 'const fs=require("fs");const p=["package.json","apps/desktop/package.json"];const v=process.argv[1];for(const f of p){const j=JSON.parse(fs.readFileSync(f,"utf8"));j.version=v;fs.writeFileSync(f,JSON.stringify(j,null,2)+"\n");}' "${VERSION}"
          fi

          node -e 'const root=require("./package.json");const desktop=require("./apps/desktop/package.json");console.log("root version:",root.version);console.log("desktop version:",desktop.version);'

      - name: Build desktop (electron-forge make)
        run: npm run make --workspace @seedworld/desktop

      - name: Collect Windows artifacts
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path release-assets/windows -Force | Out-Null
          Get-ChildItem -Path apps/desktop/out/make -Recurse -File -Filter *.zip |
            ForEach-Object { Copy-Item -Path $_.FullName -Destination release-assets/windows }
          Get-ChildItem -Path release-assets/windows -File | Format-Table -AutoSize
          if (-not (Get-ChildItem -Path release-assets/windows -File -Filter *.zip)) {
            throw "No Windows portable ZIP produced"
          }

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-assets-windows
          path: release-assets/windows/*
          if-no-files-found: error

  publish:
    runs-on: ubuntu-latest
    needs:
      - build-macos
      - build-windows
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets-macos
          path: release-assets/macos

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-assets-windows
          path: release-assets/windows

      - name: Generate SHA256 checksums
        shell: bash
        run: |
          set -euo pipefail
          find release-assets -type f -print0 | sort -z | xargs -0 sha256sum > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          prerelease: ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
          generate_release_notes: true
          fail_on_unmatched_files: false
          files: |
            release-assets/**/*
            SHA256SUMS.txt
